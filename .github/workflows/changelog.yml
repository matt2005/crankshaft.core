# Project: Crankshaft
# This file is part of Crankshaft project.
# Copyright (C) 2025 OpenCarDev Team
#
#  Crankshaft is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 3 of the License, or
#  (at your option) any later version.
#
#  Crankshaft is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with Crankshaft. If not, see <http://www.gnu.org/licenses/>.

name: Changelog

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (leave empty for auto-generated)'
        required: false
        default: ''
        type: string
  workflow_call:
    inputs:
      range:
        description: 'Git range for changelog (default: since last tag)'
        required: false
        default: ''
        type: string
    outputs:
      version:
        description: 'Generated version string'
        value: ${{ jobs.generate.outputs.version }}

jobs:
  generate:
    if: github.event_name == 'workflow_call' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine range
        id: range
        run: |
          if [ -n "${{ inputs.range }}" ]; then
            RANGE="${{ inputs.range }}"
          else
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              RANGE="$LAST_TAG..HEAD"
            else
              RANGE="HEAD"
            fi
          fi
          echo "range=$RANGE" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          RANGE="${{ steps.range.outputs.range }}"
          TODAY=$(date -u +"%Y-%m-%d")
          {
            echo "# Crankshaft Changelog"
            echo ""
            echo "Generated on ${TODAY} (UTC)"
            echo "Range: ${RANGE}"
            echo ""
            git log --pretty=format:"- %h %s" ${RANGE}
          } > changelog-ci.md

      - name: Generate version
        id: version
        run: |
          BUILD_YEAR=$(date -u +"%Y")
          BUILD_MONTH=$(date -u +"%m")
          BUILD_DAY=$(date -u +"%d")
          VERSION="${BUILD_YEAR}.${BUILD_MONTH}.${BUILD_DAY}"
          COMMIT_SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          if [ "$COMMIT_SHA" != "unknown" ]; then
            VERSION="${VERSION}+git.${COMMIT_SHA}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "${VERSION}" > version.txt

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-latest
          path: changelog-ci.md
          retention-days: 30

      - name: Upload version artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog-version
          path: version.txt
          retention-days: 30

      - name: Print summary
        run: |
          echo "Changelog generated for range: ${{ steps.range.outputs.range }}"
          head -n 20 changelog-ci.md

      - name: Update CHANGELOG.md
        if: github.event.pull_request.merged == true
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TODAY=$(date -u +"%Y-%m-%d")
          
          # Extract commits from changelog-ci.md (skip header lines)
          COMMITS=$(tail -n +6 changelog-ci.md)
          
          # Create new section
          NEW_SECTION="## [$VERSION] - $TODAY"$'\n'"$COMMITS"$'\n'
          
          # Insert after "## Unreleased" section
          if grep -q "## Unreleased" docs/CHANGELOG.md; then
            # Find line after Unreleased section content and insert
            awk -v new="$NEW_SECTION" '
              /## Unreleased/ { print; unreleased=1; next }
              unreleased && /^## / { print new; unreleased=0 }
              { print }
              END { if (unreleased) print new }
            ' docs/CHANGELOG.md > docs/CHANGELOG.md.tmp
            mv docs/CHANGELOG.md.tmp docs/CHANGELOG.md
          else
            # No Unreleased section, prepend to file
            echo -e "$NEW_SECTION\n$(cat docs/CHANGELOG.md)" > docs/CHANGELOG.md
          fi

      - name: Commit changelog
        if: github.event.pull_request.merged == true
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/CHANGELOG.md
          git diff --staged --quiet || git commit -m "Docs: update CHANGELOG.md for ${{ steps.version.outputs.version }}"
          git push
